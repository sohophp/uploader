!function(o){var i={};function l(e){if(i[e])return i[e].exports;var t=i[e]={i:e,l:!1,exports:{}};return o[e].call(t.exports,t,t.exports,l),t.l=!0,t.exports}l.m=o,l.c=i,l.d=function(e,t,o){l.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},l.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},l.t=function(t,e){if(1&e&&(t=l(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(l.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)l.d(o,i,function(e){return t[e]}.bind(null,i));return o},l.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return l.d(t,"a",t),t},l.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},l.p="",l(l.s=2)}([function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t){function i(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}e.exports=function(e,t,o){return t&&i(e.prototype,t),o&&i(e,o),e}},function(e,t,o){e.exports=o(3)},function(e,t,o){"use strict";o.r(t);var i=o(0),l=o.n(i),i=o(1),a=o.n(i),s=function(){function t(e){l()(this,t),this.jQuery=window.jQuery,this.UploaderFile=e,this.Uploader=e.Uploader,this.chunk_filename="",this.chunk_length=Math.ceil(this.UploaderFile.size/this.Uploader.opts.chunkSize),this.chunk_index=0,this.chunk_size=this.Uploader.opts.chunkSize}return a()(t,[{key:"upload",value:function(){if(!this.UploaderFile.uploadBefore())return!1;this.uploadChunk()}},{key:"getFileName",value:function(){return this._filename}},{key:"uploadChunk",value:function(){var l=this;if(!this.UploaderFile.uploadBefore())return!1;var e=new FormData,t=this.chunk_index*this.chunk_size,o="slice";Blob.prototype.webkitSlice?o="webkitSlice":Blob.prototype.mozSlice&&(o="mozSlice");var i=Math.min(this.UploaderFile.size,t+this.chunk_size);e.append("chunk",this.UploaderFile._file[o](t,i)),e.append("name",this.UploaderFile.name),e.append("id",this.UploaderFile.uid),e.append("size",this.UploaderFile.size),e.append("index",this.chunk_index),e.append("start",t),e.append("end",i),e.append("filename",this._filename);e={url:this.Uploader.opts.chunkAction,type:"POST",context:this,timeout:this.Uploader.opts.timeout,success:this.uploadSuccess,error:this.uploadError,complete:this.uploadComplete,abort:this.handleAbort,beforeSend:this.uploadBeforeSend,data:e,cache:!1,contentType:!1,processData:!1,async:!0,dataType:this.Uploader.opts.dataType,xhr:function(){var e=l.jQuery.ajaxSettings.xhr();return e.upload?e.upload.addEventListener("progress",function(e){var t=0,o=e.loaded||e.position,i=e.total;e.lengthComputable&&(t=Math.ceil(o/i*100)),l.uploadProgress(e,o,i,t)},!1):window.alert("請升級瀏覽器"),e}};this.xhr=this.jQuery.ajax(e)}},{key:"uploadProgress",value:function(e,t,o,i){console.log(i);i=t+this.chunk_index*this.chunk_size;o=this.UploaderFile.size;t=i?Math.ceil(i/o*100):0;this.UploaderFile.uploadProgress(i,o,t)}},{key:"uploadComplete",value:function(e,t){this.Uploader.log("uploadComplete:"+this.chunk_index),this.uploadIsCompleted()&&this.UploaderFile.uploadComplete(t)}},{key:"uploadError",value:function(e,t){switch(t){case"parsererror":this.Uploader.log("uploadError"),console.error("parsererror:"),console.log(e.responseText);break;case"abort":break;default:this.Uploader.log("uploadError"),console.error(t,e.responseText)}}},{key:"handleAbort",value:function(){this.Uploader.log("handleAbort"),this.UploaderFile.uploadCanceled()}},{key:"uploadSuccess",value:function(e,t,o){if(this.UploaderFile.canceled||4!==o.readyState)return console.log("success:is canceled".xhr.readyState),!1;this.Uploader.log("uploadSuccess");var i=e.results;if(!i||i.name!==this.UploaderFile.name||i.id!==this.UploaderFile.uid||!i.filename)return console.error(e,i,this.UploaderFile.name,this.UploaderFile.uid),this.UploaderFile.cancel(),!1;this._filename=i.filename,this.uploadIsCompleted()?(console.log(e),this.UploaderFile.uploadSuccess(e,t,o)):(this.chunk_index++,this.uploadChunk())}},{key:"uploadBeforeSend",value:function(){return this.Uploader.log(this.UploaderFile.qid()+":uploadBeforeSend..."),!0}},{key:"uploadIsCompleted",value:function(){return this.chunk_index+1>=this.chunk_length}}]),t}(),n=function(){function t(e){l()(this,t),this.UploaderFile=e,this.Uploader=e.Uploader}return a()(t,[{key:"upload",value:function(){var l=this;if(!this.UploaderFile.uploadBefore())return!1;var e,t=new FormData,o=this.Uploader;for(e in o.opts.data)t.append(e,o.opts.data[e]);t.append(o.opts.name,this.UploaderFile._file);var i={url:o.opts.server,type:"POST",context:this,timeout:o.opts.timeout,success:this.uploadSuccess,error:this.uploadError,complete:this.uploadComplete,abort:this.handleAbort,beforeSend:this.uploadBeforeSend,data:t,cache:!1,contentType:!1,processData:!1,async:!0,dataType:o.opts.dataType,xhr:function(){var e=$.ajaxSettings.xhr();return e.upload?e.upload.addEventListener("progress",function(e){var t=0,o=e.loaded||e.position,i=e.total;e.lengthComputable&&(t=Math.ceil(o/i*100)),l.uploadProgress(e,o,i,t)},!1):window.alert("請升級瀏覽器"),e}};this.xhr=$.ajax(i)}},{key:"uploadProgress",value:function(e,t,o,i){return this.UploaderFile.uploadProgress(t,o,i)}},{key:"uploadComplete",value:function(e,t){return this.UploaderFile.uploadComplete(t)}},{key:"uploadError",value:function(e,t,o){return this.UploaderFile.uploadError(e,t,o)}},{key:"handleAbort",value:function(){return this.UploaderFile.uploadCanceled()}},{key:"uploadSuccess",value:function(e,t,o){return this.UploaderFile.uploadSuccess(e,t,o)}},{key:"uploadBeforeSend",value:function(e){return this.UploaderFile.uploadBeforeSend(e)}}]),t}(),r=function(){function e(){l()(this,e)}return a()(e,null,[{key:"makeThumb",value:function(e){var o=this,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:100,l=2<arguments.length&&void 0!==arguments[2]?arguments[2]:100,a=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,s=new Image,t=new FileReader;return t.addEventListener("load",function(e){var t=document.createElement("img");t.addEventListener("load",function(e){o.thumbImgLoadHandler(e.target,i,l,a,s)},!1),t.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",t.src=e.target.result},!1),t.readAsDataURL(e),s}},{key:"thumbImgLoadHandler",value:function(e,t,o,i,l){var a,s,n,r,u=0,p=0,h=e.width,d=e.height,c=0,f=0;2===i?(y=o,s=a=0===(a=t)||e.width<t?this.width:a,n=y=0===o||e.height<o?this.height:y,(r=e.width/a)<(i=e.height/y)?(u=0,h=e.width,d=y*r,p=(e.height-d)/2):(p=0,d=e.height,h=a*i,u=(e.width-h)/2),t=a,o=y):(o&&e.height>o?s=(n=o)*(e.width/e.height):(s=e.width,n=e.height),t&&t<s&&(n=t*(n/s),s=t),c=(t-s)/2,f=(o-n)/2);var y=document.createElement("canvas");y.setAttribute("width",t),y.setAttribute("height",o),y.getContext("2d").drawImage(e,u,p,h,d,c,f,s,n),"function"==typeof l?l.call(e,y.toDataURL(),t,o,e):(l.src=y.toDataURL(),e.remove()),y.remove()}}]),e}(),i=function(){function o(e,t){l()(this,o),this.status=0,this.position=0,this.percent=0,this.xhr=null,this.canceled=!1,this.uid=o.qid++,this._file=t,this.name=t.name,this.type=t.type,this.size=t.size,this.total=t.size,this.Uploader=e,this.Helper=null,this.complete=0,e.opts.chunked?this.Helper=new s(this):this.Helper=new n(this)}return a()(o,[{key:"qid",value:function(){return this.uid}},{key:"upload",value:function(){return!this.canceled&&(0<this.status?(console.log("重复上传"),!1):(this.status=1,void this.Helper.upload()))}},{key:"getTotal",value:function(){return this.total}},{key:"getPosition",value:function(){return this.position}},{key:"isCompleted",value:function(){return this.complete}},{key:"isSuccess",value:function(){return 5===this.status}},{key:"isCanceled",value:function(){return this.canceled}},{key:"cancel",value:function(){var e;this.canceled=!0,console.log(this.qid()+":cancel..."),this.Helper.xhr&&this.Helper.xhr.abort&&this.Helper.xhr.abort(),this.status=4,this.canceled=!0,this.Uploader.opt("chunked")&&(e=this.Uploader.opt("chunkCancelUrl"),window.fetch(e,{method:"DELETE",body:JSON.stringify({filename:this.Helper.getFileName()}),headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"Fetcher"}}).then(function(e){console.log(e.status,e.statusText)}))}},{key:"sizeFormat",value:function(){var e=this.size;if(!e)return"0 Bytes";var t,e=parseFloat(e);return Math.round(e/Math.pow(1024,t=Math.floor(Math.log(e)/Math.log(1024)))*100,2)/100+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][t]}},{key:"uploadProgress",value:function(e,t,o){this.position=e,this.total=t,this.percent=o,"function"==typeof this.Uploader.opts.uploadProgress&&this.Uploader.opts.uploadProgress.apply(this,[this,e,t,o]),this.Uploader.allProgress()}},{key:"uploadComplete",value:function(e){this.complete=1,this.Uploader.log("uploadComplete"),"function"==typeof this.Uploader.opts.uploadComplete&&this.Uploader.opts.uploadComplete.apply(this,[this,e]),this.Uploader.isAllCompleted()&&this.Uploader.allComplete(),this.Uploader.threadNumber--,this.Uploader.nextThread()}},{key:"uploadError",value:function(e,t,o){this.status=3,this.Uploader.log("uploadError"),this.Uploader.log(t),"function"==typeof this.Uploader.opts.uploadError&&this.Uploader.opts.uploadError.apply(this,[this,e,t,o])}},{key:"uploadCanceled",value:function(){this.Uploader.log("uploadCanceled"),this.status=4,"function"==typeof this.Uploader.opts.uploadCanceled&&this.Uploader.opts.uploadCanceled.apply(this,[this])}},{key:"uploadQueued",value:function(){"function"==typeof this.Uploader.opts.uploadQueued&&this.Uploader.opts.uploadQueued.apply(this,[this])}},{key:"uploadSuccess",value:function(e,t,o){this.status=5,this.Uploader.log("uploadSuccess"),"function"==typeof this.Uploader.opts.uploadSuccess&&this.Uploader.opts.uploadSuccess.apply(this,[this,e,t,o]),this.Uploader.isAllSuccess()&&this.Uploader.allSuccess()}},{key:"uploadBeforeSend",value:function(e){return this.Uploader.log(this.qid()+":uploadBeforeSend..."),"function"!=typeof this.Uploader.opts.uploadBeforeSend||this.Uploader.opts.uploadBeforeSend.apply(this,[this,e])}},{key:"uploadBefore",value:function(){return this.Uploader.log(this.qid()+":uploadBefore..."),this.status in[0,1]?"function"!=typeof this.Uploader.opts.uploadBefore||this.Uploader.opts.uploadBefore.apply(this,[this]):(console.log("status is ".concat(this.status,"!")),!1)}},{key:"thumbImage",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:100,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:100;return r.makeThumb(this._file,e,t)}}]),o}();i.qid=0;var u=i,i=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};l()(this,t);this.opts=Object.assign({},{name:"file",selectBtn:null,uploadBtn:null,auto:!0,server:"upload.php",accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png,svg",mimeTypes:"image/*"},data:{},numThreads:3,uploadProgress:null,uploadComplete:null,uploadFailed:null,uploadError:null,uploadCanceled:null,uploadSuccess:null,uploadQueued:null,uploadBeforeSend:null,debug:0,timeout:3e5,dataType:"json",thumbWidth:60,thumbHeight:60,chunked:0,chunkSize:5242880,chunkAction:"chunkUpload.php",chunkCancelUrl:"",multiple:1,allComplete:null,allSuccess:null},e),this.files=[],this.threads=[],this.threadNumber=0,this.fileField=null,this.create()}return a()(t,[{key:"log",value:function(e){e="[SohoUploader] ".concat(e),this.opts.debug&&window.console.log(e)}},{key:"create",value:function(){var t=this;this.createFileField(),this.opts.selectBtn&&$(this.opts.selectBtn).length&&$(this.opts.selectBtn).on("click",function(e){e.preventDefault(),t.choose()}),this.opts.uploadBtn&&$(this.opts.uploadBtn).length&&$(this.opts.uploadBtn).on("click",function(e){e.preventDefault(),t.start()})}},{key:"createFileField",value:function(){var o=this;return this.fileField=document.createElement("input"),this.fileField.type="file",this.fileField.accept=this.opts.accept.mimeTypes,this.opts.multiple&&(this.fileField.multiple="multiple"),document.createDocumentFragment().appendChild(this.fileField),$(this.fileField).css({position:"absolute",left:"-1000px",top:"-1000px"}).on("change",function(e){var t=e.currentTarget;e.preventDefault(),o.log("fileField Changed"),o.addFiles(t.files),o.log("auto:"+o.opts.auto),o.opts.auto&&o.start()}),this}},{key:"addFiles",value:function(e){for(var t=0;t<e.length;t++)this.addFile(e[t]);return this}},{key:"addFile",value:function(e){e=new u(this,e);this.threads.push(e),e.uploadQueued()}},{key:"start",value:function(){this.startThread()}},{key:"startThread",value:function(){this.nextThread()}},{key:"nextThread",value:function(){var e=0;if(this.threadNumber>=this.opts.numThreads)return e;for(var t=0;t<this.threads.length;t++){var o=this.threads[t];if(0===o.status){if(this.threadNumber++,o.upload(),this.threadNumber>=this.opts.numThreads)return 1}else o.isCompleted()&&e++}e>=this.threads.length&&this.allComplete()}},{key:"isAllCompleted",value:function(){for(var e=0;e<this.threads.length;e++)if(!this.threads[e].isCompleted())return!1;return!0}},{key:"allComplete",value:function(){var e;this.log("allComplete"),"function"==typeof this.opts.allComplete&&(e=this.progress(),this.opts.allComplete.apply(this,[this,e]))}},{key:"progress",value:function(){for(var e=0,t=0,o=0,i=0;i<this.threads.length;i++){var l=this.threads[i];0<l.status&&(e+=l.getTotal(),t+=l.getPosition())}return{total:e,position:t,percent:o=t&&e?Math.ceil(t/e*100):o}}},{key:"allProgress",value:function(){var e=this.progress();"function"==typeof this.opts.allProgress&&this.opts.allProgress.apply(this,[this,e.total,e.position,e.percent])}},{key:"choose",value:function(){return $(this.fileField).trigger("click"),this}},{key:"opt",value:function(e){return this.opts[e]}},{key:"isAllSuccess",value:function(){for(var e=0;e<this.threads.length;e++)if(!this.threads[e].isSuccess())return!1;return!0}},{key:"allSuccess",value:function(){"function"==typeof this.opts.allSuccess&&this.opts.allSuccess.apply(this,[this])}}]),t}();t.default=i}]);
//# sourceMappingURL=soho-uploader.js.map